---
title: "dpcReport"
author: "Michal Burdukiewicz, Stefan Roediger"
date: ""
output:
  html_document:
    css: report.css
    toc: true
---

# dpcReport

```{r echo=FALSE, results='asis'}
library(knitr)
opts_chunk$set(echo=FALSE, results='asis', fig.align='center', fig.width=14)

library(xtable)

cool_theme <- theme(plot.background=element_rect(fill = "transparent",
                                                 colour = "transparent"),
                    panel.grid.major = element_line(colour="lightgrey", linetype = "dashed"),
                    panel.background = element_rect(fill = "white", colour = "black"),
                    legend.background = element_rect(fill="NA"),
                    legend.position = "bottom",
                    axis.text = element_text(size=12 + size_mod),
                    axis.title.x = element_text(size=15 + size_mod, vjust = -0.1), 
                    axis.title.y = element_text(size=15 + size_mod, vjust = 1),
                    strip.text = element_text(size=15 + size_mod, face = "bold"),
                    legend.text = element_text(size=12 + size_mod), 
                    legend.title = element_text(size=15 + size_mod),
                    plot.title = element_text(size=20 + size_mod))

print_dpcrtable <- function(x)
  print(xtable(x), type = "html", sanitize.colnames.function = function(x) x, digits = app_digits,
        include.rownames = FALSE)
```

Report generated on `r Sys.time()` using [dpcR](http://github.com/michbur/dpcR) R package.  

Detected input file: `r ifelse(is.null(input[["input_file"]][["name"]]), "none", input[["input_file"]][["name"]])`.  

File format: `r ifelse(is.null(input[["input_file"]][["name"]]), "none", input[["input_type"]])`.  


```{r}
if(input[["data_summary_table_rep"]])
  cat("## Data summary table  ")
```

```{r}
if(input[["data_summary_table_rep"]]) {
  source("./data_summary/summary_input.R", local = TRUE)
  print_dpcrtable(res)
}
```


```{r}
if(input[["data_summary_table_rep"]]) {
  cat(readLines("./data_summary/data_summary_table1.md"), sep = "    \n")
}
```



```{r}
if(input[["data_summary_scatter_rep"]])
  cat("## Data summary scatter charts  ")
```

```{r}
if(input[["data_summary_scatter_rep"]]) {
  source("./summary_plots/summary_plot.R", local = TRUE)
  p
}
```

```{r}
if(input[["data_summary_scatter_rep"]])
  cat(readLines("./summary_plots/data_summary_scatterchart2.md"), sep = "    \n")
```

```{r}
if(input[["data_summary_scatter_rep"]]) {
  source("./summary_plots/summary_exprep_plot.R", local = TRUE)
  p
}
```

```{r}
if(input[["data_summary_test_counts"]])
  cat("## Compare runs  ")
```

```{r}
if(input[["data_summary_test_counts"]])
  cat(readLines("./test_counts/test_counts1.md"), sep = "    \n")
```

```{r}
if(input[["data_summary_test_counts"]]) {
  source("./test_counts/test_counts_res.R", local = TRUE)
  print_dpcrtable(res)
}
```

```{r}
if(input[["data_summary_test_counts"]])
  cat(readLines("./test_counts/test_counts2.md"), sep = "    \n")
```

```{r}
if(input[["data_summary_test_counts"]]) {
  source("./test_counts/test_counts_group.R", local = TRUE)
  colnames(dat) <- c("Run", "Experiment name", "Replicate ID", "Assigned group",
                     "&lambda;", "&lambda; (lower CI)", "&lambda; (upper CI)", "k", "n")
  
  print_dpcrtable(dat)
}
```

```{r}
if(input[["data_summary_test_counts"]]) {
  source("./test_counts/test_counts_plot.R", local = TRUE)
  p
}
```

```{r}
if(input[["data_summary_test_counts"]])
  cat(readLines("./test_counts/test_counts3.md"), sep = "    \n")
```

```{r}
if(input[["plot_panel"]])
  cat("## All arrays")
```

```{r,warning=FALSE}
if(input[["plot_panel"]]) {
  new_dat <- change_data(input_dat(), as.factor(rep_names_new()), as.factor(exp_names_new()))
  for(i in colnames(new_dat)) {
    exp_run <- i
    source("./plot_panel/adpcr2panel.R", local = TRUE)
    source("./plot_panel/plot_panel.R", local = TRUE)
    print(p + ggtitle(i))
    
    roi <- extract_dpcr(new_dat, exp_run)
    res <- test_panel(roi, nx_a, ny_a, nx = input[["nx"]], ny = input[["ny"]])[[1]]
    
    cat(paste0("Experiment name: ", as.character(slot(roi, "exper")), "<br>    ", 
         "Replicate ID: ", as.character(slot(roi, "replicate")), "<br>    ",
         "Complete Spatial Randomness test statistic (", HTML("&Chi;"), "): ", 
         round(res[["statistic"]], app_digits), "<br>    ",
         "Df: ", res[["parameter"]], "<br>    ",
         "Complete Spatial Randomness test p-value: ", round(res[["p.value"]], app_digits), "<br>    ",
         "Method: ", res[["method"]], "<br>    ",
         "Alternative: ", res[["alternative"]], "<br>    "), sep = "")
  }
  
  
}
```


# R Session

```{r,results='markup'}
sessionInfo()
```